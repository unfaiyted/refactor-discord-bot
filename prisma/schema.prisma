generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Recommendation {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Original message info
  originalMessageId String   @unique
  originalChannelId String
  originalContent   String   @db.Text
  recommenderId     String
  recommenderName   String

  // Extracted URL and content info
  url               String   @db.Text
  title             String?  @db.Text
  description       String?  @db.Text

  // AI-extracted metadata
  contentType       String?  // video, podcast, article, book, tool, etc.
  topics            String[] // Array of topic/category tags
  duration          String?  // Duration or length (e.g., "45 minutes", "300 pages")
  qualityScore      Float?   // 0-10 quality score from AI
  sentiment         String?  // positive, neutral, informative, etc.
  aiSummary         String?  @db.Text
  thumbnail         String?  @db.Text // URL to thumbnail/preview image

  // Forum post info
  forumPostId       String?  @unique
  forumThreadId     String?  @unique

  // Processing status
  processed         Boolean  @default(false)
  processingError   String?  @db.Text
  processingAttempts Int     @default(0)
  processedAt       DateTime?

  // Conversation tracking
  conversationCount Int      @default(0)
  lastConversationAt DateTime?
  engagementScore   Float?   // 0-100 score based on interactions

  // Relations
  conversations     ConversationMessage[]
  engagement        ThreadEngagement?

  @@index([recommenderId])
  @@index([contentType])
  @@index([processed])
  @@index([createdAt])
  @@index([forumThreadId])
  @@map("recommendations")
}

model GuildConfig {
  id                            String   @id @default(cuid())
  guildId                       String   @unique
  createdAt                     DateTime @default(now())
  updatedAt                     DateTime @updatedAt

  // Channel configuration
  recommendationsChannelId      String?
  processedRecommendationsForumId String?

  // Feature flags
  autoProcessingEnabled         Boolean  @default(true)
  aiAnalysisEnabled             Boolean  @default(true)

  @@map("guild_configs")
}

model ProcessingLog {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())

  recommendationId  String?
  operation         String   // "extract_url", "ai_analysis", "forum_post", etc.
  status            String   // "success", "error", "retry"
  message           String?  @db.Text
  metadata          Json?    // Additional context as JSON

  @@index([recommendationId])
  @@index([createdAt])
  @@map("processing_logs")
}

model ConversationMessage {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Discord message info
  messageId         String   @unique
  threadId          String
  channelId         String

  // User info
  userId            String
  userName          String

  // Message content
  content           String   @db.Text

  // Bot response tracking
  isBot             Boolean  @default(false)
  aiResponse        String?  @db.Text
  responseTime      Int?     // Response time in milliseconds

  // Context metadata
  messageNumber     Int      // Position in conversation thread
  topicsDiscussed   String[] // AI-extracted topics from this message

  // Link to recommendation
  recommendationId  String?
  recommendation    Recommendation? @relation(fields: [recommendationId], references: [id], onDelete: Cascade)

  @@index([threadId])
  @@index([recommendationId])
  @@index([userId])
  @@index([createdAt])
  @@map("conversation_messages")
}

model ThreadEngagement {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Thread identification
  threadId          String   @unique
  recommendationId  String   @unique
  recommendation    Recommendation @relation(fields: [recommendationId], references: [id], onDelete: Cascade)

  // Engagement metrics
  totalMessages     Int      @default(0)
  userMessages      Int      @default(0)
  botMessages       Int      @default(0)
  uniqueUsers       Int      @default(0)

  // Topics and interaction patterns
  topicsDiscussed   String[] // Array of all topics discussed
  avgResponseTime   Float?   // Average bot response time in ms

  // Participation tracking
  participantIds    String[] // Array of unique user IDs
  participantNames  String[] // Array of unique user names

  // Activity timestamps
  firstMessageAt    DateTime?
  lastMessageAt     DateTime?

  // Engagement score calculation
  engagementScore   Float?   // 0-100 calculated score

  @@index([threadId])
  @@index([recommendationId])
  @@index([engagementScore])
  @@map("thread_engagement")
}
